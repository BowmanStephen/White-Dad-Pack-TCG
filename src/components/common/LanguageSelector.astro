---
/**
 * LanguageSelector Component
 * Dropdown for selecting the application language
 */

import { LOCALES, localeStore, type SupportedLocale } from '@/i18n';
import { useStore } from '@nanostores/svelte';

interface Props {
  class?: string;
}

const { class: className } = Astro.props;

// Get current locale
let currentLocale = 'en';
if (Astro.url) {
  const searchParams = new URLSearchParams(Astro.url.search);
  currentLocale = (searchParams.get('lang') as SupportedLocale) || 'en';
}
---

<div class={["language-selector", className].join(' ')}>
  <label for="language-select" class="language-selector__label">
    üåê
  </label>
  <select
    id="language-select"
    class="language-selector__select"
    data-current-locale={currentLocale}
  >
    {Object.entries(LOCALES).map(([code, { name, nativeName }]) => (
      <option value={code} selected={code === currentLocale}>
        {nativeName} ({name})
      </option>
    ))}
  </select>
</div>

<style>
  .language-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .language-selector__label {
    font-size: 1.25rem;
    cursor: pointer;
    user-select: none;
  }

  .language-selector__select {
    appearance: none;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    padding: 0.5rem 2rem 0.5rem 0.75rem;
    color: white;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.5rem center;
    min-width: 150px;
  }

  .language-selector__select:hover {
    background-color: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .language-selector__select:focus {
    outline: none;
    border-color: #f59e0b;
    box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
  }

  .language-selector__select option {
    background: #1f2937;
    color: white;
  }

  /* Dark mode variant */
  @media (prefers-color-scheme: dark) {
    .language-selector__select {
      background: rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 255, 255, 0.1);
    }
  }
</style>

<script>
  import { localeStore, loadTranslations } from '@/i18n';
  import { onMount } from 'svelte';

  const select = document.getElementById('language-select') as HTMLSelectElement;

  if (select) {
    onMount(() => {
      // Set current value
      select.value = localeStore.get();

      // Listen for changes
      select.addEventListener('change', (e) => {
        const newLocale = e.target.value as 'en' | 'es' | 'fr' | 'de';
        localeStore.set(newLocale);
        loadTranslations(newLocale);

        // Reload page to apply translations
        window.location.reload();
      });
    });
  }
</script>
