name: Visual Regression Tests

on:
  pull_request:
    paths:
      - 'src/**'
      - 'tests/visual/**'
      - 'public/**'
      - 'package.json'
      - 'tailwind.config.mjs'
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'tests/visual/**'
      - 'public/**'
      - 'package.json'
      - 'tailwind.config.mjs'

jobs:
  visual-tests:
    name: Visual Regression Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium firefox webkit

      - name: Build application
        run: bun run build

      - name: Run visual tests (Chromium)
        run: bun run test:visual

      - name: Run visual tests (all browsers)
        if: github.event_name == 'pull_request'
        run: bun run test:visual:all

      - name: Upload screenshot artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-test-screenshots
          path: |
            tests/visual/visual-tests-*/__screenshots__/
            tests/visual/*/test-results/
          retention-days: 7

      - name: Comment PR with results
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = `## üîç Visual Regression Tests Failed

            Visual tests detected unintended UI changes.

            ### üì∏ Next Steps

            1. Download the screenshot artifacts from this workflow run
            2. Compare baseline vs actual screenshots to see what changed
            3. If the change is intentional, run \`bun run test:visual:update\` and commit the new baselines
            4. If the change is unintentional, fix the UI issue

            ### üìñ Documentation

            See [VISUAL_TESTING_GUIDE.md](docs/VISUAL_TESTING_GUIDE.md) for debugging tips.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

  mobile-visual-tests:
    name: Mobile Visual Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - name: Build application
        run: bun run build

      - name: Run mobile visual tests
        run: bun run test:visual:mobile

      - name: Upload mobile screenshot artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-visual-test-screenshots
          path: |
            tests/visual/visual-tests-mobile/__screenshots__/
            tests/visual/visual-tests-mobile/test-results/
          retention-days: 7
